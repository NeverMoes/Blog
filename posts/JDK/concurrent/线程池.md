

# 线程池

[toc]

## 体系结构
![](https://i.loli.net/2020/05/04/ydzXFIHVklWZK6n.png)

1. `Executor`，`ExecutorService`：线程池相关接口。
2. `ScheduledExecutorService`：定时任务相关接口。
3. `AbstractExecutorService`：抽象类。
4. `ThreadPoolExecutor`：普通线程池，即一般所说的线程池。
5. `ScheduledThreadPoolExecutor`：定时任务线程池。
6. `ForkJoinPool`：Java7 中新增的线程池，适用于任务无限多的场景。
7. `Executors`：线程池工具类，用于快速实现线程池。

### 接口一览

#### Executor

顶级接口。

```java
public interface Executor {
    // 执行无返回值任务
    void execute(Runnable command);
}
```

#### ExecutorService

主要增加了以下四类方法：

1. 关闭线程池。
2. 判断线程池是否关闭。
3. 执行任务。
4. 批量执行任务。

```java
public interface ExecutorService extends Executor {
  	/**
  	* 关闭线程池方法
  	*/
  
    // 关闭线程池，不再接受新任务，但已经提交的任务会执行完成
    void shutdown();

    // 立即关闭线程池，尝试停止正在运行的任务，未执行的任务将不再执行
    // 被迫停止及未执行的任务将以列表的形式返回
    List<Runnable> shutdownNow();

    /**
  	* 检查关闭方法
  	*/
  
    // 检查线程池是否已关闭
    boolean isShutdown();

    // 线程池关闭后所有任务是否已经完成
    // 注意：只有在shutdown()或shutdownNow()之后调用才有可能为 true
    boolean isTerminated();
    
    // 在指定时间内线程池达到终止状态了才会返回 true
    // 超时返回 false
    // 如果过程中被中断则抛出 InterruptedException
    boolean awaitTermination(long timeout, TimeUnit unit)
        throws InterruptedException;
    
    /**
  	* 线程池执行方法
  	*/
  
    // 执行有返回值的任务，任务完成时才存在返回值
    // 任务的返回值为 task.call()
    <T> Future<T> submit(Callable<T> task);

    // 同上，返回值为传入的 result
    <T> Future<T> submit(Runnable task, T result);
    
    // 同上，返回值为 null
    Future<?> submit(Runnable task);

    // 批量执行，只有当这些任务都完成了这个方法才会返回
    <T> List<Future<T>> invokeAll(Collection<? extends Callable<T>> tasks)
        throws InterruptedException;

    // 在指定时间内批量执行任务，未执行完成的任务将被取消
    // 这里的timeout是所有任务的总时间，不是单个任务的时间
    <T> List<Future<T>> invokeAll(Collection<? extends Callable<T>> tasks,
                                  long timeout, TimeUnit unit)
        throws InterruptedException;
    
    // 返回任意一个已完成任务的执行结果，未执行完成的任务将被取消
    <T> T invokeAny(Collection<? extends Callable<T>> tasks)
        throws InterruptedException, ExecutionException;

    // 在指定时间内如果有任务已完成，则返回任意一个已完成任务的执行结果，未执行完成的任务将被取消
    <T> T invokeAny(Collection<? extends Callable<T>> tasks,
                    long timeout, TimeUnit unit)
        throws InterruptedException, ExecutionException, TimeoutException;
}
```

#### ScheduledExecutorService

添加延时任务执行方法。

```java
public interface ScheduledExecutorService extends ExecutorService {
    // 在指定延时后执行一次
    public ScheduledFuture<?> schedule(Runnable command,
                                       long delay, TimeUnit unit);
    public <V> ScheduledFuture<V> schedule(Callable<V> callable,
                                           long delay, TimeUnit unit);
                                           
    // 在指定延时后开始执行，并在之后以指定时间间隔重复执行（间隔不包含任务执行的时间）
    // 即间隔延时以任务开始计算
    public ScheduledFuture<?> scheduleAtFixedRate(Runnable command,
                                                  long initialDelay,
                                                  long period,
                                                  TimeUnit unit);

    // 在指定延时后开始执行，并在之后以指定延时重复执行（间隔包含任务执行的时间）
    // 即间隔延时以任务结束计算
    public ScheduledFuture<?> scheduleWithFixedDelay(Runnable command,
                                                     long initialDelay,
                                                     long delay,
                                                     TimeUnit unit);

}
```

```java

```

```java

```

```java

```

```java

```





官方文档中的注释

```java

```





## 小结

`ExecutorService`中

* `void shutdown()`
* `List<Runnable> shutdownNow()`
* 

的区别

---

* `boolean isShutdown();`
* `boolean isTerminated();`
* `boolean awaitTermination(long timeout, TimeUnit unit) throws InterruptedException;`
* 

## 参考

1. [死磕 java线程系列之线程池深入解析——体系结构](https://juejin.im/post/5da499af518825237369f4c1)

[如何设置线程池参数？](https://mp.weixin.qq.com/s?__biz=MzI3NzE0NjcwMg==&mid=2650127132&idx=3&sn=a2c9b3f1b7a085ec413ca28759d7e22e)

